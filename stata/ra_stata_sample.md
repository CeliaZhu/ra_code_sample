---
title: Stata Code Sample [^1]
author: Xiling (Celia) Zhu <xiling@uchicago.edu>
date: Aug 28, 2020
header-includes:
  - \usepackage{multicol, graphicx, float}
---

## Background

In January 2012, the Cook County State’s Attorney’s Office established a program
intended to reduce re-arrest among people on bail awaiting trial.
The program ran through October 2013.

The objective of our analysis is to evaluate the effectiveness of the program.
We start by cleaning data sets on demographics, arrrests information, and academic performance.
We provide descriptive statistics for the study population
and test their baseline equivalence. The final step is to evaluate whether
participating in the program reduces the likelihood of re-arrest before disposition.

## 0. Preamble
[^1]: Generated by `markstat`. For souce code, please see my github repository [here](https://github.com/CeliaZhu/ra_code_sample/blob/master/stata/ra_stata_sample.stmd).


{{1}}


## 1. Data Cleaning

### 1.1 Clean demographic data


{{2}}


The demographic data were extracted from a system that inconsistently coded gender.
Recode it so that males are consistently coded as “M” and females are consistently coded as “F”.


{{3}}



### 1.2 Clean arrests data (data on arrests is named as "case")

Merge the case and demo datasets together so that each row in the case dataset
also contains the demographics of the defendant.
It's possible to have one person with multiple cases.

I didn't find other variables (except person_id) in demo and case sharing same variable names.


{{4}}


While the program was mostly rolled out to defendants in Chicago,
the State’s Attorney’s Office also ran a pilot serving a small number of individuals
arrested in other parts of Cook County.

For the purpose of this analysis, please restrict the data to only individuals
who were arrested in Chicago.

I first change all addresses to lower case because it's possible to have "Chicago"
inconsistently capitalized as "CHICAGO", "Chicago", or even "chicago".


{{5}}


Create an age variable equal to the defendant’s age at the time of arrest for each case.


{{6}}


### 1.3 Clean grade data for defendants in their early early adulthood

The State’s Attorney’s Office has requested 9th and 10th grade course
grade data from defendants between the ages of 18 and 24.
These data are included in grades.csv.
Construct measures for 9th and 10th grade GPA for this target population.
When constructing GPA, use a 4 point scale, where: A=4, B=3, C=2, D=1, and F=0.


{{7}}


## 2. Statistical Analysis

Determine if the program should be continued/expanded
by estimating the program’s effect on **re-arrests prior to disposition**.

Because we only have grades data for young adults,
I did not use these data to inform your statistical analysis.


{{8}}


### 2.1 Summary statistics of study population

The study population are predominantly male, with only 20% cases having female
defendants. As to race, 73% of the cases involve Black defendants, only 22% are white,
and 5% are Asian. On average, the study population has around 4 prior arrests
before the case arrest date, and their average age is approximately 30.


{{9}}

\begin{table}[H]
\centering
\caption{Summary statistics of study population}
\input{/Users/celiazhu/Box/projects/ra_code_sample/stata/output/summary_statistics.tex}
\end{table}

### 2.2 Balance tests for demographic characteristics

The enrolled and unenrolled groups are not balanced at the baseline.

The average numbers of prior arrests are significantly different in the two groups.
Cases with more prior arrests are more likely to be enrolled into the program.

Their age is also imbalanced. Cases with older defendants are more likely to be enrolled
into the program.

The imbalance are not due to random coincidence.
The F-test indicates that these covariates didn't pass joint orthogonality, either.

The imbalance at baseline signals the problem of selection.


{{10}}

\begin{table}[H]
\centering
\caption{Balance test}
\input{/Users/celiazhu/Box/projects/ra_code_sample/stata/output/balance_test.tex}
\end{table}

### 2.3 Visualize number of prior arrests by enrollment status and race

Create a numerical variable for race


{{11}}

\begin{figure}[H]
\centering
\caption{Number of prior arrests imbalanced bewteen enrolled and unerolled groups}
\includegraphics[width = \textwidth]{/Users/celiazhu/Box/projects/ra_code_sample/stata/output/prior_arrests.png}
\end{figure}

### 2.4 Estimate the effect of the program on reducing the likelihood of re-arrest before disposition

One difficulty in estimating the effect of the program is that I don't have
enough information about the program: if program was an randomized controlled trial
and if so, how was the compliance, or if it was an observational study.

#### Specification 1: OLS (or Linear Probaility Model)

We start with ``naive" OLS model.

$$
        rearrest_{ic} = \tau treat_{ic} + \beta X_{ic} + \epsilon_{ic} + \epsilon_{i}
$$

where $i$ is the individual,  $c$ is the case, $X_{ic}$ is the vector for race,
gender, age, and number of prior arrests.
We could have added individual fixed effects $u_{i}$ to control for those
individual-invariant characteristics. But by examining the unique values of
`person_id`, we can conclude that for most defendants, they only have one or two
cases. Individual fixed effect is not desirable here.

It can correctly estimate the average treatment effect (ATE) if
this program was a \textbf{randomized experiment} with perfect compliance;
or it was an \textbf{observational study} satisfying the two conditions:
1) there is no selection on unobservables and we've controlled
all observables that could be selected upon;
and 2) how people are self-selected based on those variables can be approximated
by a linear function. But these conditions are unlikely to be true.

That said, suppose the program was a randomized controlled trial, the treatment was
administered on the case level, not on the individual level.
Hence, we don't cluster standard errors here.

#### Specification 2: Logit

Assume the program was not an experimental study, we can improve our \textbf{prediction} on the likelihood
by using a logit model instead of a linear probability model, which was implemented in
specification 1. But the results given by logit specification is for prediction,
not for causal inference.

$$
  Pr(rearrest = 1 | X_c) = \frac{exp^{X_c'\beta}}{1 + e^{X_c'\beta}}
$$


#### Specification 3: Inverse Probability Weighting (IPW)

To estimate the causal effect via propensity score matching (more specifically,
inverse probability weighting (IPW)), given that the program was \textbf{observational},
not experimental, we still need to assume that there is \textbf{no selection on unobservables}
and we've controlled all observables that could be selected upon.
One improvement from OLS or logit model is that we can relax the assumption on the
functional form.

One improvement from OLS or logit model is that we can relax the assumption on
the functional form. Still, the estimate based upon IPW is not entirely valid,
because we omit important characteristics such as grades, household income,
neighborhood, etc.. However, this is less restrictive and therefore more plausible
than the other two models.

First, calculate propensity and inverse probability weight (ipw).


{{12}}


Before we estimate average treatment effect (ATE) and average treatment effect
on the treated (ATET) of this program, we first assess the validity of propensity
score by 1) the distribution of the propensity score, 2) summary statistics of
observations within the common support, and 3) the balance of the sample within
common support, weighted by the IPW for ATE.

1) Assess the distribution of the propensity score in enrolled and unerolled groups


{{13}}


\begin{figure}[H]
\centering
\caption{histogram of propensity score by enrollment status}
\includegraphics[width = \textwidth]{/Users/celiazhu/Box/projects/ra_code_sample/stata/output/ps_hist.png}
\end{figure}

2) Summary statistics of observations within common support, weighted by inverse probability for ATE

{{14}}

\begin{table}[H]
\centering
\caption{Summary statistics for observations within common support, weighted by inverse probability for ATE}
\input{/Users/celiazhu/Box/projects/ra_code_sample/stata/output/summary_statistics_cs.tex}
\end{table}

3) Balance test for observations within common support, weighted by inverse probability
for ATE


{{15}}

\begin{table}[H]
\centering
\caption{Balance test for observation within common support, weighted by inverse probability for ATE}
\input{/Users/celiazhu/Box/projects/ra_code_sample/stata/output/balance_test_ipw.tex}
\end{table}

OLS regression

{{16}}


Logit regression

{{17}}


Estimate ATE and ATET with inverse probability weighting.

{{18}}


Export results from three specifications

{{19}}


\begin{table}[H]
\centering
\caption{Estimation}
\input{/Users/celiazhu/Box/projects/ra_code_sample/stata/output/estimation.tex}
\end{table}

## 3. Conclusion
Overall, the treatment significantly reduces the likelihood of re-arrest before disposition.
With the information we have from the pilot study, we can conclude that the program is
effective and should be furthered examined with an experiment.

However, please note that the causal inference has much room for improvement.
Though the sample on the common support and weighted by the inverse probability
for ATE is balanced, the distribution of propensity score is not ideal. Some cases
not selected into the program still have relatively high propensity score. And the
distribution didn't improve much when I added higher-ordered terms, like age squared.

The causal inference would have better performance if we can obtain more characteristics.
To name a few, household income, and the neighborhoods defendants live in; and for younger defendants,
we can also incorporate their academic performance and disciplinary incidents in school,
and the school districts they live in.
