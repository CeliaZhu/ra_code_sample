---
title: Stata Code Sample
author: Xiling Zhu <xiling@uchicago.edu>
date: Aug 28, 2020
header-includes:
  - \usepackage{multicol}
  - \usepackage{tabularx}
  - \usepackage{booktabs}
  - \usepackage{lscape}
  - \usepackage{graphicx}
  - \usepackage{float}
---

## Background

In January 2012, the Cook County State’s Attorney’s Office established a program
intended to reduce re-arrest among people on bail awaiting trial.
The program ran through October 2013.

The objective of our analysis is to evaluate the effectiveness of the program.
We start by cleaning data sets on demographics, arrrests information, and academic performance.
We proceed to provide descriptive statistics for the study population
and test their baseline equivalence. The final step is to evaluate whether
participating in the program reduces the likelihood of re-arrest before disposition.

## 0. Preamble [^1]
[^1]: Generated by `markstat`. Please see [here](https://github.com/CeliaZhu/ra_code_sample/blob/master/ra_stata_sample.stmd) for source code.


{{1}}



{{2}}


## 1. Data Cleaning

### 1.1 Clean demographic data


{{3}}


Make sure person_id is uid


{{4}}


The demographic data were extracted from a system that inconsistently coded gender.
Recode it so that males are consistently coded as “M” and females are consistently coded as “F”.


{{5}}


Check if gender is consistently coded


{{6}}


Save cleaned demographic data


{{7}}


### 1.2 Clean arrests data (data on arrests is named as case)


{{8}}


Make sure caseid is uid


{{9}}


Merge the case and demo datasets together so that each row in the case dataset also contains the demographics of the defendant.
It's possible to have one person with multiple cases.

Note: No other variables (except person_id) in demo and case sharing the same variable name


{{10}}


While the program was mostly rolled out to defendants in Chicago,
the State’s Attorney’s Office also ran a pilot serving a small number of individuals
arrested in other parts of Cook County.

For the purpose of this analysis, please restrict the data to only individuals
who were arrested in Chicago.

I first change all addresses to lower case because it's possible to have "Chicago" inconsistently capitalized as "CHICAGO", "Chicago", or even "chicago".


{{11}}


Create an age variable equal to the defendant’s age at the time of arrest for each case.

Glimpse the `arrest_date` and `bdate` to know their formats.


{{12}}



{{13}}


Save cleaned case and demographic data


{{14}}


### 1.3 Clean grade data for defendants in their early early adulthood

The State’s Attorney’s Office has requested 9th and 10th grade course
grade data from defendants between the ages of 18 and 24.
These data are included in grades.csv.
Construct measures for 9th and 10th grade GPA for this target population.
When constructing GPA, use a 4 point scale, where: A=4, B=3, C=2, D=1, and F=0.

Import grade data


{{15}}


Construct 9th and 10th GPA for defendants between the age of 18 and 24


{{16}}



{{17}}


Sanity check on GPAs


{{18}}


Keep person id and gpa for grade 9 and 10


{{19}}


## 2. Statistical Analysis

Determine if the program should be continued/expanded
by estimating the program’s effect on re-arrests prior to disposition.

Do not use gpa to inform analysis because theses are only for young adults


{{20}}


The study population should have 25,000 subjects


{{21}}


Label variables for cleaner output.


{{22}}


Create dummies for gender and race.


{{23}}



{{24}}


Define a local macro for covariates.


{{25}}


### 2.1 Summary statistics of study population

Describe the demographic characteristics of the study population based on the data available.


{{26}}


\begin{table}[H]
\centering
\caption{Summary statistics of study population}
\input{/Users/celiazhu/Box/projects/ra_code_sample/output/summary_statistics.tex}
\end{table}

### 2.2 Balance tests for demographic characteristics

The enrolled and unenrolled groups are not balanced. The average numbers of arrests
prior to the case arrest date are significantly different in two groups.
Cases with more prior arrests are more likely to be enrolled into the program.
The age characteristic is also imbalanced.
Cases with older defendants are more likely to be enrolled into the program.
It signals the existence of selection.

Test the baseline equivalence of demographic characteristics.
We use t-test and joint F-test to check both the balance of individual covariates and joint orthognality.

First, we check for balance variable by variable.


{{27}}




{{28}}



{{29}}



{{30}}



{{31}}


Now we check for joint orthognality.


{{32}}



{{33}}



{{34}}



{{35}}


The final step of this balance test is to format and export balance tables.
We label the statistics and coerce the numerical statistics to strings, in order to preserve the two-digits format in the output.


{{36}}



{{37}}



{{38}}



{{39}}



{{40}}

EOD (end of today)

\begin{table}[H]
\centering
\caption{Balance test for individual covariates}
\input{/Users/celiazhu/Box/projects/ra_code_sample/output/balance_test.tex}
\end{table}

\begin{table}[H]
\centering
\caption{Balance test for all covariates}

### 2.3 Visualize number of prior arrests by enrollment status and race

Create a numerical variable for race


{{41}}



{{42}}



{{43}}


Calculate means and confidence intervals


{{44}}



{{45}}



{{46}}


Count observations


{{47}}



{{48}}



{{49}}


Plot the bar chart


{{50}}



{{51}}



{{52}}


\begin{figure}[H]
\centering
\caption{Number of prior arrests imbalanced bewteen enrolled and unerolled groups}
\includegraphics[width = 0.8\textwidth]{/Users/celiazhu/Box/projects/ra_code_sample/output/prior_arrests.png}
\end{figure}

### 2.4 Estimate the effect of the program on reducing the likelihood of re-arrest before disposition

One difficulty is that we don't have enough information about the implementation of the program.
We are not sure if the program was randomized and how was the compliance.

#### Specification 1: OLS

$$
        rearrest_{ic} = \tau treat_{ic} + \beta X_{ic} + \epsilon_{ic} + \epsilon_{i}
$$
where $i$ is the individual, $c$ is the case, $X$ is the vector for prior arrests, gender, race, and age.

We start with "naive" OLS. It can correctly estimate the average treatment effect if
this program was a \textbf{randomized experiment} with perfect compliance;
or it was an \textbf{observational study} satisfying the two conditions: 1) there is no selection on
unobservables and we've controlled all observables that could be selected upon;
and 2) how people are self-selected based on those variables can be approximated
by a linear function. But these conditions are unlikely to be true.

If the program was a randomized trial, the treatment was administered on the case level,
not on the individual level. Hence, we don't cluter standard errors here.

Also, by examining the unique values of `person_id`, we can conclude that for most
defendants, they only have one or two cases. Indiviudal fixed effects is not desirable here.


{{53}}



{{54}}



{{55}}


#### Specification 2: Logit

$$
  Pr(rearrest = 1 | X_c) = \frac{exp^{X_c'\beta}}{1 + e^{X_c'\beta}}
$$

Assume the program was not an experiment, we can improve our \textbf{prediction} on the likelihood
by using a logit model instead of a linear probability model, which was implemented in
specification 1. But the results given by logit specification is for prediction,
not for causal inference.


{{56}}


#### Specification 3: Weighted propensity score matching

To estimate the causal effect of this treatment given that the program was observational,
not experimental, we still need to assume that there is no selection on unobservables
and we've controlled all observables that could be selected upon.
But we can relax the assumption on the functional form.

Still, the estimate based upon propensity score matching is not entirely valid,
because we omit variables such as grades, household income, etc..

However, this is less restrictive and therefore more plausible than the OLS estimate,
and better serves the purpose of causal inference compared to logit estimate.


{{57}}


Common support


{{58}}


Weight for average treatment effect (ATE)


{{59}}


Weight for average treatment effect on the treated (ATET)


{{60}}


Export results of three specifications


{{61}}


\begin{table}[H]
\centering
\caption{Estimation}
\input{/Users/celiazhu/Box/projects/ra_code_sample/output/estimation.tex}
\end{table}

## 3. Conclusion
Overall, the treatment significantly reduces the likelihood of re-arrest before disposition.
With the information we have, we can conclude that the program is effective and should be expanded or continued, or should be furthered examined with an experiment.

However, please note that the causal inference has much room for improvement.
It would have better performance if we can obtain more relevant variables,
such as grades, household income, neighboorhoods.
