{smcl}
{com}{sf}{ul off}{txt}{.-}
      name:  {res}<unnamed>
       {txt}log:  {res}/Users/celiazhu/Box/projects/ra_code_sample/ra_stata_sample.smcl
  {txt}log type:  {res}smcl
 {txt}opened on:  {res}31 Aug 2020, 07:58:33
{txt}
{com}. //_1
.   clear all
{res}{txt}
{com}.   set more off
{txt}
{com}.   set varabbrev off
{txt}
{com}. //_2
.   global data /Users/celiazhu/Box/projects/ra_code_sample/data
{txt}
{com}.   global output /Users/celiazhu/Box/projects/ra_code_sample/output
{txt}
{com}.   global processed /Users/celiazhu/Box/projects/ra_code_sample/processed
{txt}
{com}. //_3
.   import delimited "$data/demo.csv", clear
{res}{text}(4 vars, 20,436 obs)

{com}. //_4
.   duplicates drop

{p 0 4}{txt}Duplicates in terms of {txt} all variables{p_end}

(4,721 observations deleted)

{com}.   isid person_id
{txt}
{com}. //_5
.   tab gender, m

     {txt}gender {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          F {c |}{res}      2,936       18.68       18.68
{txt}          M {c |}{res}     11,707       74.50       93.18
{txt}     female {c |}{res}        179        1.14       94.32
{txt}       male {c |}{res}        893        5.68      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     15,715      100.00
{txt}
{com}.   replace gender = "F" if gender == "female"
{txt}(179 real changes made)

{com}.   replace gender = "M" if gender == "male"
{txt}(893 real changes made)

{com}. //_6
.   assert gender == "M" | gender == "F"
{txt}
{com}. //_7
.   save "$processed/demo_clean.dta", replace
{txt}file /Users/celiazhu/Box/projects/ra_code_sample/processed/demo_clean.dta saved

{com}. //_8
.   import delimited "$data/case.csv", clear
{res}{text}(8 vars, 26,000 obs)

{com}. //_9
.   isid caseid
{txt}
{com}. //_10
.   merge m:1 person_id using "$processed/demo_clean.dta", nogen keep(3)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}          26,000{txt}  
{col 5}{hline 41}

{com}. //_11
.   replace address = lower(address)
{txt}(26,000 real changes made)

{com}.   keep if strpos(address, ", chicago") > 0
{txt}(1,000 observations deleted)

{com}. //_12
.   qui: codebook arrest_date bdate
{txt}
{com}. //_13
.   foreach var of varlist arrest_date bdate{c -(}
{txt}  2{com}.     gen `var'_dt = date(`var', "YMD")
{txt}  3{com}.   {c )-}
{txt}
{com}.   gen age = round((arrest_date_dt - bdate_dt)/365.25,0.1)
{txt}
{com}. //_14
.   save "$processed/case_demo_clean.dta", replace
{txt}file /Users/celiazhu/Box/projects/ra_code_sample/processed/case_demo_clean.dta saved

{com}. //_15
.   import delimited "$data/grades.csv", clear
{res}{text}(17 vars, 11,251 obs)

{com}. //_16
.   foreach g of varlist gr* {c -(}
{txt}  2{com}.     gen byte n_`g' = cond(`g' == "A", 4, ///
>                 cond(`g' == "B", 3, ///
>                 cond(`g' == "C", 2, ///
>                 cond(`g' == "D", 1, ///
>                 cond(`g' == "F", 0, .)))))
{txt}  3{com}.   {c )-}
{txt}(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)
(2,251 missing values generated)

{com}. //_17
.   forvalues i = 9/10{c -(}
{txt}  2{com}.     local grade`i' n_gr`i'_*
{txt}  3{com}.      egen gpa`i' = rmean(`grade`i'')
{txt}  4{com}.   {c )-}
{txt}
{com}. //_18
.   su gpa9

{txt}    Variable {c |}        Obs        Mean    Std. Dev.       Min        Max
{hline 13}{c +}{hline 57}
{space 8}gpa9 {c |}{res}     11,251    2.661426    .6469981          0          4
{txt}
{com}.   su gpa10

{txt}    Variable {c |}        Obs        Mean    Std. Dev.       Min        Max
{hline 13}{c +}{hline 57}
{space 7}gpa10 {c |}{res}     11,251    2.661316    .6479062        .25          4
{txt}
{com}. //_19
.   keep person_id gpa*
{txt}
{com}.   isid person_id
{txt}
{com}.   save "$processed/grades_clean.dta", replace
{txt}file /Users/celiazhu/Box/projects/ra_code_sample/processed/grades_clean.dta saved

{com}. //_20
.   use "$processed/case_demo_clean.dta", clear
{txt}
{com}. //_21
.   assert(_N == 25000)
{txt}
{com}. //_22
.   label var age "Age"
{txt}
{com}.   label var prior_arrests "Number of prior arrests"
{txt}
{com}.   label var re_arrest "Re-arrested"
{txt}
{com}.   label var treat "Enrolled into program"
{txt}
{com}. //_23
.   tab gender, m gen(gender_)

     {txt}gender {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          F {c |}{res}      4,936       19.74       19.74
{txt}          M {c |}{res}     20,064       80.26      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     25,000      100.00
{txt}
{com}.   rename gender_1 female
{res}{txt}
{com}.   label var female "Female"
{txt}
{com}.   rename gender_2 male
{res}{txt}
{com}.   label var male "Male"
{txt}
{com}. //_24
.   tab race, m gen(race_)

       {txt}race {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      ASIAN {c |}{res}      1,239        4.96        4.96
{txt}      BLACK {c |}{res}     18,249       73.00       77.95
{txt}      WHITE {c |}{res}      5,512       22.05      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     25,000      100.00
{txt}
{com}.   rename race_1 asian
{res}{txt}
{com}.   rename race_2 black
{res}{txt}
{com}.   rename race_3 white
{res}{txt}
{com}.   label var asian "Asian"
{txt}
{com}.   label var black "Black"
{txt}
{com}.   label var white "White"
{txt}
{com}. //_25
.   local balancevar "female male asian black white prior_arrests age"
{txt}
{com}. //_26
.   eststo clear
{txt}
{com}.   qui estpost su `balancevar'
{txt}
{com}.   esttab using "$output/summary_statistics.tex", replace ///
>   cells("mean sd min max") nonumber booktabs
{res}{txt}(output written to {browse  `"/Users/celiazhu/Box/projects/ra_code_sample/output/summary_statistics.tex"'})

{com}. //_27
.   balancetable treat `balancevar' using "$output/balance_test.tex", ///
>   vce(robust) pval ///
>   ctitles("Control group" "Treatment group" "Difference" "P value") ///
>   booktabs varlabels replace
{res}{txt}
{com}. //_28
.   preserve
{txt}
{com}.   encode race, gen(n_race)
{txt}
{com}. //_29
.   qui: codebook n_race
{txt}
{com}. //_30
.   gen avg = .
{txt}(25,000 missing values generated)

{com}.   gen ci_low = .
{txt}(25,000 missing values generated)

{com}.   gen ci_high = .
{txt}(25,000 missing values generated)

{com}. //_31
.   qui: mean prior_arrests, over(treat n_race)
{txt}
{com}.   matrix M = r(table)
{txt}
{com}.   matrix list M
{res}
{txt}M[9,6]
         prior_arr~s:  prior_arr~s:  prior_arr~s:  prior_arr~s:  prior_arr~s:  prior_arr~s:
           _subpop_1     _subpop_2     _subpop_3     _subpop_4     _subpop_5     _subpop_6
     b {res}    3.1284722     3.1516698      3.158808     4.2880845     4.3943896     4.3575673
{txt}    se {res}    .07721162     .01987445     .03608994     .07927011      .0227264     .04104244
{txt}     t {res}    40.518155     158.57896     87.526007     54.094593     193.36061     106.17222
{txt}pvalue {res}            0             0             0             0             0             0
{txt}    ll {res}    2.9771329     3.1127147     3.0880696     4.1327104     4.3498445     4.2771217
{txt}    ul {res}    3.2798115     3.1906249     3.2295464     4.4434586     4.4389347     4.4380129
{txt}    df {res}        24999         24999         24999         24999         24999         24999
{txt}  crit {res}    1.9600589     1.9600589     1.9600589     1.9600589     1.9600589     1.9600589
{txt} eform {res}            0             0             0             0             0             0
{reset}
{com}. //_32
.   forvalues i = 1/6 {c -(}
{txt}  2{com}.       if inrange(`i', 1, 3) == 1{c -(}
{txt}  3{com}.       replace avg = M[1, `i'] if treat == 0 & n_race == `i'
{txt}  4{com}.       replace ci_low = M[5, `i'] if treat == 0 & n_race == `i'
{txt}  5{com}.       replace ci_high = M[6, `i'] if treat == 0 & n_race == `i'
{txt}  6{com}.       {c )-}
{txt}  7{com}. //_33
.       if inrange(`i', 4, 6) == 1 {c -(}
{txt}  8{com}.       replace avg = M[1, `i'] if treat == 1 & n_race == `i'-3
{txt}  9{com}.       replace ci_low = M[5, `i'] if treat == 1 & n_race == `i'-3
{txt} 10{com}.       replace ci_high = M[6, `i'] if treat == 1 & n_race == `i'-3
{txt} 11{com}.       {c )-}
{txt} 12{com}.   {c )-}
{txt}(576 real changes made)
(576 real changes made)
(576 real changes made)
(8,624 real changes made)
(8,624 real changes made)
(8,624 real changes made)
(2,651 real changes made)
(2,651 real changes made)
(2,651 real changes made)
(663 real changes made)
(663 real changes made)
(663 real changes made)
(9,625 real changes made)
(9,625 real changes made)
(9,625 real changes made)
(2,861 real changes made)
(2,861 real changes made)
(2,861 real changes made)

{com}. //_34
.   forvalues i = 1/6 {c -(}
{txt}  2{com}.       if inrange(`i', 1, 3) == 1 {c -(}
{txt}  3{com}.       count if treat == 0 & n_race == `i' & !missing(prior_arrests)
{txt}  4{com}.       {c )-}
{txt}  5{com}. //_35
.       if inrange(`i', 4, 6) == 1 {c -(}
{txt}  6{com}.       count if treat == 1 & n_race == `i'-3 & !missing(prior_arrests)
{txt}  7{com}.       {c )-}
{txt}  8{com}. //_36
.       local `i'N = r(N)
{txt}  9{com}.   {c )-}
  {res}576
  8,624
  2,651
  663
  9,625
  2,861
{txt}
{com}. //_37
.   gen treat_race = n_race if treat == 0
{txt}(13,149 missing values generated)

{com}.   replace treat_race = n_race + 4 if treat == 1
{txt}(13,149 real changes made)

{com}. //_38
.   twoway (bar avg treat_race if n_race == 1, fcolor(maroon) ///
>           fintensity(inten70) lcolor(white) barw(0.7)) ///
>          (bar avg treat_race if n_race == 2, fcolor(maroon) ///
>          fintensity(inten50) lcolor(white) barw(0.7)) ///
>          (bar avg treat_race if n_race == 3, fcolor(maroon) ///
>          fintensity(inten30) lcolor(white) barw(0.7)) ///
>              (rcap ci_low ci_high treat_race, lcolor(gs5)), ///
>          legend(row(1) order(1 "Asian" 2 "Black" 3 "White" 4 "95% C.I.")) ///
>          xlabel(2"Unenrolled" 6"Enrolled", noticks) xtitle("Enrollment status") ///
>          ylabel(0(1)4) ytitle("Average number of prior arrests", ///
>          margin(medium) size(medium)) ///
>          title("Number of prior arrests imbalanced" ///
>          "between enrolled and unenrolled groups", size(medium)) ///
>          note("Number of defendants:" ///
>          "Asian unenrolled `1N', Black unenrolled `2N', White unenrolled `3N'" ///
>            "Asian enrolled `4N', Black enrolled `5N', White enrolled `6N'") ///
>          caption("Source: Cook County State's Attorney's Office", ///
>          justification(left) size(vsmall) linegap(0.8) position(5) span) ///
>          graphregion( color(white) ) plotregion(fcolor(white))
{res}{txt}
{com}. //_39
.   graph export "$output/prior_arrests.png", replace
{txt}(file /Users/celiazhu/Box/projects/ra_code_sample/output/prior_arrests.png written in PNG format)

{com}.   restore
{txt}
{com}. //_40
.   unique person_id
{txt}Number of unique values of person_id is  {res}14353
{txt}Number of records is  {res}25000
{txt}
{com}. //_41
.   eststo clear
{txt}
{com}. //_42
.   eststo: qui reg re_arrest treat `balancevar', rob
{txt}({res}est1{txt} stored)

{com}. //_43
.   eststo: qui logit re_arrest treat `balancevar', rob
{txt}({res}est2{txt} stored)

{com}. //_44
.   qui logit treat `balancevar'
{txt}
{com}.   predict pscore
{txt}(option {bf:pr} assumed; Pr(treat))

{com}. //_45
.   forvalues i = 1/2 {c -(}
{txt}  2{com}.     su pscore if treat == `i' -1
{txt}  3{com}.     drop if inrange(pscore, r(min), r(max)) == 0
{txt}  4{com}.   {c )-}

{txt}    Variable {c |}        Obs        Mean    Std. Dev.       Min        Max
{hline 13}{c +}{hline 57}
{space 6}pscore {c |}{res}     11,851    .4821746    .1287615   .2568446   .9319222
{txt}(16 observations deleted)

    Variable {c |}        Obs        Mean    Std. Dev.       Min        Max
{hline 13}{c +}{hline 57}
{space 6}pscore {c |}{res}     13,133    .5649514    .1451764   .2577653   .9314315
{txt}(5 observations deleted)

{com}. //_46
.   gen ate_weight = (1/pscore) if treat == 1
{txt}(11,846 missing values generated)

{com}.   replace ate_weight = 1/(1-pscore) if treat == 0
{txt}(11,846 real changes made)

{com}.   eststo: qui reg re_arrest treat [pw = ate_weight]
{txt}({res}est3{txt} stored)

{com}. //_47
.   gen atet_weight = 1 if treat == 1
{txt}(11,846 missing values generated)

{com}.   replace atet_weight = pscore/(1-pscore) if treat == 0
{txt}(11,846 real changes made)

{com}.   eststo: qui reg re_arrest treat [pw = atet_weight]
{txt}({res}est4{txt} stored)

{com}. //_48
. esttab using "$output/estimation.tex", se booktabs label ///
> addnotes("Model 1: OLS; Model 2: Logit;" ///
> "Model 3: Propensity score matching (ATT); Model 4: Propensity Score Matching (ATET)" ///
> "Souce: Cook County State's Attorney's Office") ///
> replace numbers
{res}{txt}(output written to {browse  `"/Users/celiazhu/Box/projects/ra_code_sample/output/estimation.tex"'})

{com}. //_^
. log close
      {txt}name:  {res}<unnamed>
       {txt}log:  {res}/Users/celiazhu/Box/projects/ra_code_sample/ra_stata_sample.smcl
  {txt}log type:  {res}smcl
 {txt}closed on:  {res}31 Aug 2020, 07:58:54
{txt}{.-}
{smcl}
{txt}{sf}{ul off}